<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quick Work – Neon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>

  <!-- Leaflet (Map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ====== NEON THEME ====== */
    :root{
      --bg:#000;
      --neon:#00ffcc;
      --muted:#0a2a2a;
      --card:#001616;
      --text:#dffdf7;
      --danger:#ff3860;
      --ok:#39ff14;
      --border:rgba(0,255,204,.5);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh;
      overflow-x:hidden;
      text-align:center;
    }
    /* Matrix-y animated background */
    body::before{
      content:"";
      position:fixed;inset:0;
      background: radial-gradient(ellipse at top, rgba(0,255,204,.12), transparent 60%),
                  radial-gradient(ellipse at bottom, rgba(0,255,204,.08), transparent 60%),
                  repeating-linear-gradient(180deg, rgba(0,255,204,.04) 0 2px, transparent 2px 6px);
      animation: shimmer 12s linear infinite;
      z-index:-1;
    }
    @keyframes shimmer{0%{filter:hue-rotate(0)}100%{filter:hue-rotate(360deg)}}

    h1,h2,h3{
      color:var(--neon);
      text-shadow: 0 0 10px var(--neon), 0 0 30px var(--neon);
      letter-spacing:.5px;
      margin:12px 0;
    }

    .container{
      width:min(960px, 92vw);
      margin: 16px auto 80px;
    }

    .card{
      background:linear-gradient(180deg, rgba(0,255,204,.06), rgba(0,255,204,.02));
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: 0 0 24px rgba(0,255,204,.15);
      padding:18px;
      margin:12px auto;
      width:100%;
    }

    .row{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
    .col{flex:1 1 280px;max-width:360px}

    input,select,button,textarea{
      width:100%;
      padding:12px 14px;
      margin:8px 0;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      outline:none;
    }
    textarea{resize:vertical;min-height:80px}
    input::placeholder,textarea::placeholder{color:#9deedf}

    .btn{
      background:transparent;
      border:2px solid var(--neon);
      color:var(--neon);
      font-weight:700;
      cursor:pointer;
      text-shadow:0 0 6px var(--neon);
      transition:.2s ease;
      box-shadow:0 0 8px rgba(0,255,204,.35);
    }
    .btn:hover{background:var(--neon);color:#002521;box-shadow:0 0 22px var(--neon)}
    .btn-danger{border-color:var(--danger);color:var(--danger)}
    .btn-danger:hover{background:var(--danger);color:#000}
    .btn-ok{border-color:var(--ok);color:var(--ok)}
    .btn-ok:hover{background:var(--ok);color:#002521}

    .badge{
      display:inline-block;padding:4px 10px;border:1px solid var(--border);
      border-radius:999px;background:rgba(0,255,204,.08);color:var(--neon);font-size:12px
    }
    .muted{opacity:.8}

    .hidden{display:none !important}

    /* Bottom Navbar */
    .navbar{
      position:fixed;left:0;right:0;bottom:0;
      display:flex;gap:8px;justify-content:space-around;align-items:center;
      background:rgba(0,0,0,.9);border-top:1px solid var(--border);
      padding:10px 6px;backdrop-filter: blur(6px);
    }
    .navbtn{
      background:transparent;border:none;color:var(--neon);
      text-shadow:0 0 5px var(--neon);cursor:pointer;font-size:13px
    }
    .navbtn:focus{outline:2px solid var(--border);border-radius:8px}

    /* Map */
    #map{height:260px;border-radius:12px;border:1px solid var(--border);}

    /* Tiny grid for panels */
    .panel-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:780px){.panel-grid{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>⚡ Quick Work</h1>

    <!-- ===== AUTH: SIGNUP ===== -->
    <section id="signupSection" class="card">
      <h2>Create Account</h2>
      <div class="row">
        <div class="col">
          <input id="su_name" placeholder="Full Name" />
          <input id="su_email" type="email" placeholder="Email" />
          <input id="su_pass" type="password" placeholder="Password" />
        </div>
        <div class="col">
          <select id="su_role">
            <option value="">-- Select Role --</option>
            <option value="customer">Customer</option>
            <option value="mechanic">Mechanic</option>
          </select>
          <input id="su_department" placeholder="Department (for Mechanic)" />
          <input id="su_mobile" placeholder="Mobile Number" />
        </div>
      </div>
      <button class="btn" id="btnSignup">Signup</button>
      <p class="muted">Already have an account? <a href="#" onclick="showSection('loginSection')">Login here</a></p>
    </section>

    <!-- ===== AUTH: LOGIN ===== -->
    <section id="loginSection" class="card hidden">
      <h2>Welcome Back</h2>
      <div class="row">
        <div class="col">
          <input id="li_email" type="email" placeholder="Email" />
        </div>
        <div class="col">
          <input id="li_pass" type="password" placeholder="Password" />
        </div>
      </div>
      <button class="btn" id="btnLogin">Login</button>
      <p class="muted">No account? <a href="#" onclick="showSection('signupSection')">Create one</a></p>
    </section>

    <!-- ===== CUSTOMER PANEL ===== -->
    <section id="customerPanel" class="hidden">
      <div class="panel-grid">
        <div class="card">
          <h2>Find Mechanics</h2>
          <div id="mechanicList" class="row"></div>
        </div>

        <div class="card">
          <h2>My Bookings</h2>
          <div id="customerBookings" class="row"></div>
        </div>
      </div>
    </section>

    <!-- ===== MECHANIC PANEL ===== -->
    <section id="mechanicPanel" class="hidden">
      <div class="panel-grid">
        <div class="card">
          <h2>My Status</h2>
          <p>Toggle your availability for customers.</p>
          <div class="row">
            <div class="col">
              <button class="btn btn-ok" id="btnGoOnline">🔘 Go Online</button>
            </div>
            <div class="col">
              <button class="btn btn-danger" id="btnGoOffline">⛔ Go Offline</button>
            </div>
          </div>
          <p class="muted">Current: <span id="statusBadge" class="badge">offline</span></p>
        </div>

        <div class="card">
          <h2>Booking Requests</h2>
          <div id="mechanicRequests" class="row"></div>
        </div>
      </div>

      <div class="card">
        <h2>Map</h2>
        <div id="map"></div>
      </div>
    </section>
  </div>

  <!-- ===== BOTTOM NAVBAR ===== -->
  <div class="navbar">
    <button class="navbtn" onclick="showSection('signupSection')">Home</button>
    <button class="navbtn" onclick="showSection('customerPanel')">Customer</button>
    <button class="navbtn" onclick="showSection('mechanicPanel')">Mechanic</button>
    <button class="navbtn" onclick="doLogout()">Logout</button>
  </div>

<script>
/* =========================
   SUPABASE CONFIG
========================= */
const SUPABASE_URL = "https://fzkjrtudqirpefxsvilc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6a2pydHVkcWlycGVmeHN2aWxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMjEyNjcsImV4cCI6MjA3MDg5NzI2N30.aSZaNoz5BXESVeYnRAU_cNuOmaN7mOi0nd5-FEN-fZk";
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   UI HELPERS
========================= */
function showSection(id){
  const ids = ["signupSection","loginSection","customerPanel","mechanicPanel"];
  ids.forEach(i => document.getElementById(i).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
function toast(msg){ alert(msg); }
function telLink(num){ return `tel:${(num||"").replace(/\s+/g,"")}` }
function smsLink(num){ return `sms:${(num||"").replace(/\s+/g,"")}` }

/* =========================
   SIGNUP / LOGIN
========================= */
document.getElementById("btnSignup").addEventListener("click", signup);
document.getElementById("btnLogin").addEventListener("click", login);

async function signup(){
  const name = document.getElementById("su_name").value.trim();
  const email = document.getElementById("su_email").value.trim();
  const pass = document.getElementById("su_pass").value;
  const role = document.getElementById("su_role").value;
  const dept = document.getElementById("su_department").value.trim();
  const mobile = document.getElementById("su_mobile").value.trim();

  if(!name||!email||!pass||!role||!mobile){
    toast("Please fill all required fields.");
    return;
  }
  if(role==="mechanic" && !dept){
    toast("Department is required for Mechanics.");
    return;
  }

  const { data, error } = await supa.auth.signUp({ email, password: pass });
  if(error){ toast(error.message); return; }

  const uid = data.user?.id;
  if(!uid){ toast("Signup failed. Try again."); return; }

  const { error: perr } = await supa.from("profiles").insert([
    { id: uid, name, role, department: dept, mobile, status: "offline" }
  ]);
  if(perr){ toast("Profile save error: "+perr.message); return; }

  toast("Signup successful! Please login.");
  showSection("loginSection");
}

async function login(){
  const email = document.getElementById("li_email").value.trim();
  const pass = document.getElementById("li_pass").value;
  const { data, error } = await supa.auth.signInWithPassword({ email, password: pass });
  if(error){ toast(error.message); return; }

  const user = data.user;
  const { data: prof } = await supa.from("profiles").select("*").eq("id", user.id).single();

  if(prof?.role === "mechanic"){
    showSection("mechanicPanel");
    document.getElementById("statusBadge").textContent = prof.status || "offline";
    await loadMechanicRequests();
    initMap();
  }else{
    showSection("customerPanel");
    await loadMechanics();
    await loadCustomerBookings();
  }
}

async function doLogout(){
  await supa.auth.signOut();
  showSection("loginSection");
}

/* =========================
   CUSTOMER: LIST + BOOK
========================= */
async function loadMechanics(){
  const { data: list, error } = await supa.from("profiles")
      .select("id,name,department,mobile,status")
      .eq("role","mechanic")
      .order("status", { ascending: false });
  if(error){ toast(error.message); return; }

  const wrap = document.getElementById("mechanicList");
  wrap.innerHTML = "";
  (list||[]).forEach(m=>{
    const div = document.createElement("div");
    div.className = "card col";
    div.innerHTML = `
      <h3>${m.name}</h3>
      <p><span class="badge">${m.department || "General"}</span></p>
      <p class="muted">Status: <b>${m.status||"offline"}</b></p>
      <div class="row">
        <div class="col"><a class="btn" href="${telLink(m.mobile)}">📞 Call</a></div>
        <div class="col"><a class="btn" href="${smsLink(m.mobile)}">✉ SMS</a></div>
      </div>
      <textarea id="bn_${m.id}" placeholder="Describe the issue (optional)"></textarea>
      <button class="btn" onclick="bookMechanic('${m.id}')">🛠 Book</button>
    `;
    wrap.appendChild(div);
  });
}

async function bookMechanic(mechanicId){
  const session = await supa.auth.getSession();
  const customerId = session.data.session?.user?.id;
  const notes = (document.getElementById(`bn_${mechanicId}`)?.value || "").trim();

  if(!customerId){ toast("Please login again."); return; }

  const { error } = await supa.from("bookings").insert([
    { customer_id: customerId, mechanic_id: mechanicId, status: "pending", notes }
  ]);
  if(error){ toast(error.message); return; }

  toast("Booking request sent!");
  await loadCustomerBookings();
}

async function loadCustomerBookings(){
  const session = await supa.auth.getSession();
  const cid = session.data.session?.user?.id;
  if(!cid) return;

  // Include mechanic profile via foreign key
  const { data, error } = await supa
    .from("bookings")
    .select("id,status,created_at,notes, mechanic:profiles!bookings_mechanic_id_fkey(name,mobile,department)")
    .eq("customer_id", cid)
    .order("created_at", { ascending:false });

  if(error){ toast(error.message); return; }

  const wrap = document.getElementById("customerBookings");
  wrap.innerHTML = "";
  (data||[]).forEach(b=>{
    const div = document.createElement("div");
    div.className="card col";
    div.innerHTML = `
      <h3>${b.mechanic?.name || "Mechanic"}</h3>
      <p>${b.mechanic?.department || ""}</p>
      <p>Status: <span class="badge">${b.status}</span></p>
      <p class="muted">${new Date(b.created_at).toLocaleString()}</p>
      <div class="row">
        <div class="col"><a class="btn" href="${telLink(b.mechanic?.mobile)}">📞 Call</a></div>
        <div class="col"><a class="btn" href="${smsLink(b.mechanic?.mobile)}">✉ SMS</a></div>
      </div>
      ${b.notes ? `<p class="muted">You wrote: ${b.notes}</p>`:""}
    `;
    wrap.appendChild(div);
  });
}

/* =========================
   MECHANIC: REQUESTS + STATUS
========================= */
document.getElementById("btnGoOnline").addEventListener("click", ()=> setStatus("online"));
document.getElementById("btnGoOffline").addEventListener("click", ()=> setStatus("offline"));

async function setStatus(status){
  const session = await supa.auth.getSession();
  const mid = session.data.session?.user?.id;
  if(!mid) return;
  const { error } = await supa.from("profiles").update({ status }).eq("id", mid);
  if(error){ toast(error.message); return; }
  document.getElementById("statusBadge").textContent = status;
}

async function loadMechanicRequests(){
  const session = await supa.auth.getSession();
  const mid = session.data.session?.user?.id;
  if(!mid) return;

  // include customer profile (name, mobile)
  const { data, error } = await supa
    .from("bookings")
    .select("id,status,created_at,notes, customer:profiles!bookings_customer_id_fkey(name,mobile)")
    .eq("mechanic_id", mid)
    .order("created_at", { ascending:false });

  if(error){ toast(error.message); return; }

  const wrap = document.getElementById("mechanicRequests");
  wrap.innerHTML = "";
  (data||[]).forEach(b=>{
    const div = document.createElement("div");
    div.className="card col";
    div.innerHTML = `
      <h3>Request from ${b.customer?.name || "Customer"}</h3>
      <p>Status: <span class="badge">${b.status}</span></p>
      <p class="muted">${new Date(b.created_at).toLocaleString()}</p>
      ${b.notes? `<p class="muted">Issue: ${b.notes}</p>`:""}
      <div class="row">
        <div class="col"><a class="btn" href="${telLink(b.customer?.mobile)}">📞 Call</a></div>
        <div class="col"><a class="btn" href="${smsLink(b.customer?.mobile)}">✉ SMS</a></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn btn-ok" onclick="updateBooking(${b.id}, 'accepted')">✅ Accept</button></div>
        <div class="col"><button class="btn btn-danger" onclick="updateBooking(${b.id}, 'rejected')">❌ Reject</button></div>
      </div>
    `;
    wrap.appendChild(div);
  });
}

async function updateBooking(id, status){
  const { error } = await supa.from("bookings").update({ status }).eq("id", id);
  if(error){ toast(error.message); return; }
  await loadMechanicRequests();
}

/* =========================
   MAP (Leaflet)
========================= */
let mapInit = false;
function initMap(){
  if(mapInit) return;
  mapInit = true;
  const map = L.map('map').setView([28.6139, 77.2090], 11); // Delhi default
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19
  }).addTo(map);
  L.marker([28.6139,77.2090]).addTo(map).bindPopup("Your city").openPopup();
}

/* =========================
   SESSION RESTORE
========================= */
(async function restore(){
  const { data } = await supa.auth.getSession();
  const user = data.session?.user;
  if(!user){ showSection("signupSection"); return; }

  const { data: prof } = await supa.from("profiles").select("*").eq("id", user.id).single();
  if(prof?.role==="mechanic"){
    showSection("mechanicPanel");
    document.getElementById("statusBadge").textContent = prof.status || "offline";
    await loadMechanicRequests();
    initMap();
  }else{
    showSection("customerPanel");
    await loadMechanics();
    await loadCustomerBookings();
  }
})();
</script>

</body>
</html>
